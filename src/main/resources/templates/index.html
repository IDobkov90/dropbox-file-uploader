<!DOCTYPE html>
<html lang="bg" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—á–≤–∞–Ω–µ –Ω–∞ —Ñ–∞–π–ª –≤ Dropbox</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Arial', sans-serif; background-color: #f8f9fa; }
        .upload-container { max-width: 600px; margin: 50px auto; }
        .status-badge { margin-bottom: 20px; }
        .file-drop-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background-color: white;
            transition: all 0.3s ease;
        }
        .file-drop-area:hover { border-color: #007bff; background-color: #f8f9ff; }
        .file-drop-area.dragover { border-color: #007bff; background-color: #e7f3ff; }
        .progress { margin-top: 20px; display: none; }
        .result { margin-top: 20px; }
    </style>
</head>
<body>
<div class="container">
    <div class="upload-container">
        <h1 class="text-center mb-4">üìÅ –ö–∞—á–≤–∞–Ω–µ –Ω–∞ —Ñ–∞–π–ª –≤ Dropbox</h1>

        <div class="status-badge text-center">
            <span th:if="${connectionStatus}" class="badge bg-success">‚úÖ –°–≤—ä—Ä–∑–∞–Ω —Å Dropbox</span>
            <span th:unless="${connectionStatus}" class="badge bg-danger">‚ùå –ù–µ –µ —Å–≤—ä—Ä–∑–∞–Ω —Å Dropbox</span>
        </div>

        <div class="card" th:if="${connectionStatus}">
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <!-- Add CSRF token -->
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                    <div class="mb-3">
                        <label for="filename" class="form-label">–ò–º–µ –Ω–∞ —Ñ–∞–π–ª–∞ (–Ω–∞ –∫–∏—Ä–∏–ª–∏—Ü–∞ —Å—ä—Å —Å–ø–µ–π—Å–æ–≤–µ):</label>
                        <input type="text" class="form-control" id="filename" name="filename"
                               placeholder="–î–æ–∫—É–º–µ–Ω—Ç –∑–∞ –ø–µ—á–∞—Ç 2024" value="–î–æ–∫—É–º–µ–Ω—Ç –∑–∞ –ø–µ—á–∞—Ç">
                    </div>

                    <div class="file-drop-area mb-3" id="fileDropArea">
                        <input type="file" id="fileInput" name="file" class="d-none" required>
                        <div class="drop-content">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <p class="mb-2">–ö–ª–∏–∫–Ω–µ—Ç–µ —Ç—É–∫ –∏–ª–∏ –ø—É—Å–Ω–µ—Ç–µ —Ñ–∞–π–ª–∞</p>
                            <small class="text-muted">–ü–æ–¥–¥—ä—Ä–∂–∞–Ω–∏ —Ñ–æ—Ä–º–∞—Ç–∏: –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, PDF</small><br>
                            <small class="text-muted">–ú–∞–∫—Å–∏–º–∞–ª–µ–Ω —Ä–∞–∑–º–µ—Ä: 10MB</small>
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg" id="uploadBtn">
                            <span class="spinner-border spinner-border-sm d-none" id="uploadSpinner"></span>
                            üì§ –ö–∞—á–∏ —Ñ–∞–π–ª–∞
                        </button>
                    </div>
                </form>

                <div class="progress mt-3" id="uploadProgress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                </div>

                <div class="result" id="result"></div>
            </div>
        </div>

        <div class="card" th:unless="${connectionStatus}">
            <div class="card-body">
                <div class="alert alert-warning">
                    <h5>‚ö†Ô∏è –ù—è–º–∞ –≤—Ä—ä–∑–∫–∞ —Å Dropbox</h5>
                    <p>–ú–æ–ª—è, –ø—Ä–æ–≤–µ—Ä–µ—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ –∏ –æ–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const fileDropArea = document.getElementById('fileDropArea');
    const fileInput = document.getElementById('fileInput');
    const uploadForm = document.getElementById('uploadForm');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadSpinner = document.getElementById('uploadSpinner');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = uploadProgress.querySelector('.progress-bar');
    const result = document.getElementById('result');

    // Define allowed file types
    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'application/pdf'];

    // File drop functionality
    if (fileDropArea) {
        fileDropArea.addEventListener('click', () => fileInput.click());
        fileDropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileDropArea.classList.add('dragover');
        });
        fileDropArea.addEventListener('dragleave', () => {
            fileDropArea.classList.remove('dragover');
        });
        fileDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropArea.classList.remove('dragover');
            fileInput.files = e.dataTransfer.files;
            updateFileDisplay();
        });
    }

    if (fileInput) {
        fileInput.addEventListener('change', updateFileDisplay);
    }

    function updateFileDisplay() {
        const file = fileInput.files[0];
        if (file) {
            // Validate file type
            if (!allowedTypes.includes(file.type)) {
                fileDropArea.innerHTML = `
                    <div class="selected-file text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <p class="mb-1"><strong>${file.name}</strong></p>
                        <small>–ù–µ–ø–æ–¥–¥—ä—Ä–∂–∞–Ω —Ç–∏–ø —Ñ–∞–π–ª. –ú–æ–ª—è, –∏–∑–±–µ—Ä–µ—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ PDF.</small>
                    </div>
                `;
                return;
            }

            // Show file info
            fileDropArea.innerHTML = `
                <div class="selected-file">
                    <i class="fas fa-file fa-2x text-primary mb-2"></i>
                    <p class="mb-1"><strong>${file.name}</strong></p>
                    <small class="text-muted">${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                </div>
            `;
        }
    }

    if (uploadForm) {
        uploadForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const file = fileInput.files[0];
            if (!file) {
                result.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>‚ùå –ì—Ä–µ—à–∫–∞</h5>
                        <p>–ú–æ–ª—è, –∏–∑–±–µ—Ä–µ—Ç–µ —Ñ–∞–π–ª –∑–∞ –∫–∞—á–≤–∞–Ω–µ</p>
                    </div>
                `;
                return;
            }

            // Validate file type in frontend
            if (!allowedTypes.includes(file.type)) {
                result.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>‚ùå –ì—Ä–µ—à–∫–∞</h5>
                        <p>–ù–µ–ø–æ–¥–¥—ä—Ä–∂–∞–Ω —Ç–∏–ø —Ñ–∞–π–ª. –ú–æ–ª—è, –∏–∑–±–µ—Ä–µ—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ PDF.</p>
                    </div>
                `;
                return;
            }

            // Validate file size in frontend
            if (file.size > 10 * 1024 * 1024) {
                result.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>‚ùå –ì—Ä–µ—à–∫–∞</h5>
                        <p>–§–∞–π–ª—ä—Ç –µ —Ç–≤—ä—Ä–¥–µ –≥–æ–ª—è–º (–º–∞–∫—Å–∏–º—É–º 10MB)</p>
                    </div>
                `;
                return;
            }

            // Create a new FormData object and explicitly append the file
            const formData = new FormData();
            formData.append('file', file);

            // Get the filename from the form and append it
            const filename = document.getElementById('filename').value;
            formData.append('filename', filename);

            // Add CSRF token
            const csrfToken = document.querySelector('input[name="_csrf"]');
            if (csrfToken) {
                formData.append(csrfToken.name, csrfToken.value);
            }

            uploadBtn.disabled = true;
            uploadSpinner.classList.remove('d-none');
            uploadProgress.style.display = 'block';
            progressBar.style.width = '0%';
            result.innerHTML = '';

            // Use XMLHttpRequest for progress tracking
            const xhr = new XMLHttpRequest();

            // Track upload progress
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    progressBar.style.width = percentComplete + '%';
                    progressBar.setAttribute('aria-valuenow', percentComplete);
                }
            });

            // Handle response
            xhr.onload = function() {
    if (xhr.status === 200) {
        try {
            const data = JSON.parse(xhr.responseText);
            if (data.success) {
                // Decode the path before displaying it
                const decodedPath = decodeURIComponent(data.path);
                result.innerHTML = `
                    <div class="alert alert-success">
                        <h5>‚úÖ –£—Å–ø–µ—à–Ω–æ –∫–∞—á–≤–∞–Ω–µ!</h5>
                        <p>–§–∞–π–ª—ä—Ç –µ –∫–∞—á–µ–Ω –≤: <code>${decodedPath}</code></p>
                    </div>
                `;
            } else {
                result.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>‚ùå –ì—Ä–µ—à–∫–∞</h5>
                        <p>${data.message}</p>
                    </div>
                `;
            }
        } catch (error) {
            handleError();
        }
    } else {
        handleError();
    }

    finishUpload();
};

            // Handle errors
            xhr.onerror = function() {
                handleError();
                finishUpload();
            };

            // Open and send the request
            xhr.open('POST', '/upload', true);
            xhr.send(formData);

            function handleError() {
                result.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>‚ùå –ì—Ä–µ—à–∫–∞</h5>
                        <p>–í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ –∫–∞—á–≤–∞–Ω–µ—Ç–æ –Ω–∞ —Ñ–∞–π–ª–∞</p>
                    </div>
                `;
            }

            function finishUpload() {
                uploadBtn.disabled = false;
                uploadSpinner.classList.add('d-none');
                uploadProgress.style.display = 'none';
            }
        });
    }
</script>
</body>
</html>